/**
 * @license React
 * react-server-dom-webpack-plugin.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */

'use strict';

'use strict';var q=require("path"),r=require("url"),x=require("neo-async"),y=require("webpack/lib/dependencies/ModuleDependency"),z=require("webpack/lib/dependencies/NullDependency"),A=require("webpack/lib/Template"),B=require("webpack");const C=Array.isArray;class D extends y{constructor(b){super(b)}get type(){return"client-reference"}}const E=require.resolve("../client.browser.js");
class F{constructor(b){this.ssrManifestFilename=this.clientManifestFilename=this.chunkName=this.clientReferences=void 0;if(!b||"boolean"!==typeof b.isServer)throw Error("React Server Plugin: You must specify the isServer option as a boolean.");if(b.isServer)throw Error("TODO: Implement the server compiler.");b.clientReferences?"string"!==typeof b.clientReferences&&C(b.clientReferences)?this.clientReferences=b.clientReferences:this.clientReferences=[b.clientReferences]:this.clientReferences=[{directory:".",
recursive:!0,include:/\.(js|ts|jsx|tsx)$/}];"string"===typeof b.chunkName?(this.chunkName=b.chunkName,/\[(index|request)\]/.test(this.chunkName)||(this.chunkName+="[index]")):this.chunkName="client[index]";this.clientManifestFilename=b.clientManifestFilename||"react-client-manifest.json";this.ssrManifestFilename=b.ssrManifestFilename||"react-ssr-manifest.json"}apply(b){const m=this;let p,t=!1;b.hooks.beforeCompile.tapAsync("React Server Plugin",(c,a)=>{c=c.contextModuleFactory;const d=b.resolverFactory.get("context",
{});m.resolveAllClientFiles(b.context,d,b.inputFileSystem,c,function(e,g){e?a(e):(p=g,a())})});b.hooks.thisCompilation.tap("React Server Plugin",(c,a)=>{a=a.normalModuleFactory;c.dependencyFactories.set(D,a);c.dependencyTemplates.set(D,new z.Template);c=d=>{d.hooks.program.tap("React Server Plugin",()=>{const e=d.state.module;if(e.resource===E&&(t=!0,p))for(let h=0;h<p.length;h++){const n=p[h];var g=m.chunkName.replace(/\[index\]/g,""+h).replace(/\[request\]/g,A.toPath(n.userRequest));g=new B.AsyncDependenciesBlock({name:g},
null,n.request);g.addDependency(n);e.addBlock(g)}})};a.hooks.parser.for("javascript/auto").tap("HarmonyModulesPlugin",c);a.hooks.parser.for("javascript/esm").tap("HarmonyModulesPlugin",c);a.hooks.parser.for("javascript/dynamic").tap("HarmonyModulesPlugin",c)});b.hooks.make.tap("React Server Plugin",c=>{c.hooks.processAssets.tap({name:"React Server Plugin",stage:B.Compilation.PROCESS_ASSETS_STAGE_REPORT},function(){if(!1===t)c.warnings.push(new B.WebpackError("Client runtime at react-server-dom-webpack/client was not found. React Server Components module map file "+
m.clientManifestFilename+" was not created."));else{var a={},d={};c.chunkGroups.forEach(function(g){function h(k,f){if(/\.(js|ts)x?$/.test(f.resource)){var l=c.moduleGraph.getExportsInfo(f).getProvidedExports(),u={},w={};d[k]=w;["","*"].concat(Array.isArray(l)?l:[]).forEach(function(v){u[v]={id:k,chunks:n,name:v};w[v]={specifier:f.resource,name:v}});l=r.pathToFileURL(f.resource).href;void 0!==l&&(a[l]=u,d[l]=w)}}const n=g.chunks.map(function(k){return k.id});g.chunks.forEach(function(k){k=c.chunkGraph.getChunkModulesIterable(k);
Array.from(k).forEach(function(f){const l=c.chunkGraph.getModuleId(f);h(l,f);f.modules&&f.modules.forEach(u=>{h(l,u)})})})});var e=JSON.stringify(a,null,2);c.emitAsset(m.clientManifestFilename,new B.sources.RawSource(e,!1));e=JSON.stringify(d,null,2);c.emitAsset(m.ssrManifestFilename,new B.sources.RawSource(e,!1))}})})}resolveAllClientFiles(b,m,p,t,c){x.map(this.clientReferences,(a,d)=>{"string"===typeof a?d(null,[new D(a)]):m.resolve({},b,a.directory,{},(e,g)=>{if(e)return d(e);t.resolveDependencies(p,
{resource:g,resourceQuery:"",recursive:void 0===a.recursive?!0:a.recursive,regExp:a.include,include:void 0,exclude:a.exclude},(h,n)=>{if(h)return d(h);h=n.map(k=>{var f=q.join(g,k.userRequest);f=new D(f);f.userRequest=k.userRequest;return f});d(null,h)})})},(a,d)=>{if(a)return c(a);a=[];for(let e=0;e<d.length;e++)a.push.apply(a,d[e]);c(null,a)})}}module.exports=F;
